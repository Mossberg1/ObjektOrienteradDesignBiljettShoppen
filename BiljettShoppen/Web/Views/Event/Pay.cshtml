@model Web.Models.PayViewModel

@{
    ViewData["Title"] = "Betalning";
}

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <h1 class="mb-4">Slutför din betalning</h1>

            <!-- Order Summary Card -->
            <div class="card mb-4">
                <div class="card-header">
                    <h4>Din beställning</h4>
                </div>
                <div class="card-body">
                    <h5 class="card-title">@Model.EventName</h5>
                    <hr />
                    <div class="d-flex justify-content-between fs-5 fw-bold">
                        <span>Totalt att betala:</span>
                        <span>@Model.TotalPrice.ToString("C")</span>
                    </div>
                </div>
            </div>

            <!-- Payment Form -->
            <form id="paymentForm" asp-action="ProcessPayment" method="post">
                @Html.AntiForgeryToken()
                <input type="hidden" asp-for="BookingReference" />
                <input type="hidden" name="paymentMethod" id="paymentMethod" value="" />

                <h4>Välj betalningsmetod</h4>
                <div class="accordion" id="paymentAccordion">

                    <!-- Betala med kort -->
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingCard">
                            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseCard" aria-expanded="true" aria-controls="collapseCard">
                                Betala med kort
                            </button>
                        </h2>
                        <div id="collapseCard" class="accordion-collapse collapse show" aria-labelledby="headingCard" data-bs-parent="#paymentAccordion">
                            <div class="accordion-body">
                                <div class="mb-3">
                                    <label for="creditCardForm.Email" class="form-label">E-post</label>
                                    <input type="email" id="creditCardForm.Email" name="creditCardForm.Email" class="form-control" placeholder="din.epost@exempel.com" required>
                                </div>
                                <div class="mb-3">
                                    <label for="creditCardForm.Name" class="form-label">Namn på kortet</label>
                                    <input type="text" id="creditCardForm.Name" name="creditCardForm.Name" class="form-control" placeholder="John Doe" required>
                                </div>
                                <div class="mb-3">
                                    <label for="creditCardForm.CardNumber" class="form-label">Kortnummer</label>
                                    <input type="text" id="creditCardForm.CardNumber" name="creditCardForm.CardNumber" class="form-control" placeholder="0000 0000 0000 0000" required>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="creditCardForm.ExpiryDate" class="form-label">Giltig till</label>
                                        <input type="text" id="creditCardForm.ExpiryDate" name="creditCardForm.ExpiryDate" class="form-control" placeholder="MM/ÅÅ" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="creditCardForm.Cvc" class="form-label">CVC</label>
                                        <input type="text" id="creditCardForm.Cvc" name="creditCardForm.Cvc" class="form-control" placeholder="123" required>
                                    </div>
                                </div>
                                <button type="submit" name="paymentMethod" value="CreditCard" class="btn btn-primary w-100">Betala @Model.TotalPrice.ToString("C")</button>
                            </div>
                        </div>
                    </div>

                    <!-- Betala med faktura -->
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingInvoice">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseInvoice" aria-expanded="false" aria-controls="collapseInvoice">
                                Betala med faktura
                            </button>
                        </h2>
                        <div id="collapseInvoice" class="accordion-collapse collapse" aria-labelledby="headingInvoice" data-bs-parent="#paymentAccordion">
                            <div class="accordion-body">
                                <p>En faktura kommer att skickas till den angivna e-postadressen. Betalningsvillkor 14 dagar.</p>
                                <div class="mb-3">
                                    <label for="invoiceForm.Email" class="form-label">E-post för faktura</label>
                                    <input type="email" id="invoiceForm.Email" name="invoiceForm.Email" class="form-control" placeholder="din.epost@exempel.com" required>
                                </div>
                                <button type="submit" name="paymentMethod" value="Invoice" class="btn btn-primary w-100">Bekräfta och få faktura</button>
                            </div>
                        </div>
                    </div>

                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal för bokning som har utgått -->
<div class="modal fade" id="bookingExpiredModal" tabindex="-1" aria-labelledby="bookingExpiredLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="bookingExpiredLabel">Bokning utgången</h5>
            </div>
            <div class="modal-body">
                Din bokningstid har gått ut. Du kommer att omdirigeras tillbaka till händelselistan.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="redirectBtn">OK</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal för lyckad betalning. -->
<div class="modal fade" id="paymentSuccessModal" tabindex="-1" aria-labelledby="paymentSuccessLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="paymentSuccessLabel">Betalning lyckades</h5>
            </div>
            <div class="modal-body">
                Din betalning har genomförts och bekräftelsen har laddats ner automatiskt.<br />
                Om du har valt faktura skickas den via epost. Även bekräftelsen skickas via epost.
            </div>
            <div class="modal-footer">
                <button type="button" id="successRedirectBtn" class="btn btn-primary">Tillbaka till evenemang</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const form = document.getElementById('paymentForm');
            if (!form) return;

            let paymentSubmitted = false;

            const cardInputs = Array.from(document.querySelectorAll('[name^="creditCardForm."]'));
            const invoiceInputs = Array.from(document.querySelectorAll('[name^="invoiceForm."]'));
            const cardPanel = document.getElementById('collapseCard');
            const invoicePanel = document.getElementById('collapseInvoice');
            const accordion = document.getElementById('paymentAccordion');
            const paymentMethodHidden = document.getElementById('paymentMethod')

            function updateRequired() {
                const cardShown = cardPanel && cardPanel.classList.contains('show');
                const invoiceShown = invoicePanel && invoicePanel.classList.contains('show');

                cardInputs.forEach(i => i.required = !!cardShown);
                invoiceInputs.forEach(i => i.required = !!invoiceShown);
            }

            updateRequired();

            try {
                if (accordion) {
                    accordion.addEventListener('shown.bs.collapse', updateRequired);
                    accordion.addEventListener('hidden.bs.collapse', updateRequired);
                }
            } catch (e) { }

            form.querySelectorAll('button[type="submit"][name="paymentMethod"]').forEach(btn => {
                btn.addEventListener('click', function () {
                    if (paymentMethodHidden) paymentMethodHidden.value = this.value;
                });
            });

            form.addEventListener('keydown', function (e) {
                if (e.key !== 'Enter') return;

                const tag = (e.target && e.target.tagName || '').toLowerCase();
                if (tag === 'textarea') return;
                if (e.target && (e.target.type === 'submit' || e.target.tagName.toLowerCase() === 'button')) return;

                const methodButtons = Array.from(form.querySelectorAll('button[type="submit"][name="paymentMethod"]'));
                let targetButton = methodButtons.find(b => b.closest('.accordion-collapse')?.classList.contains('show'));

                if (!targetButton) targetButton = methodButtons.find(b => b.offsetParent !== null) || methodButtons[0];

                if (targetButton) {
                    e.preventDefault();
                    targetButton.click();
                }
            });

            form.addEventListener('submit', async function (e) {
                e.preventDefault();
                updateRequired();

                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }

                const submitButton = form.querySelector('button[type="submit"]');
                if (submitButton) submitButton.disabled = true;

                try {
                    const action = form.getAttribute('action') || window.location.href;
                    const method = (form.getAttribute('method') || 'POST').toUpperCase();
                    const formData = new FormData(form);

                    const response = await fetch(action, {
                        method,
                        body: formData,
                        credentials: 'same-origin'
                    });

                    if (!response.ok) {
                        let txt = '';
                        try { txt = await response.text(); } catch {}
                        alert('Betalning misslyckades. Server svarade: ' + (txt || response.statusText));
                        return;
                    }

                    paymentSubmitted = true;

                    const contentType = response.headers.get('content-type') || '';
                    if (contentType.indexOf('application/pdf') === -1) {
                        const text = await response.text();
                        alert('Server response: ' + text);
                        return;
                    }

                    const blob = await response.blob();

                    function getFileNameFromContentDisposition(header) {
                        if (!header) return null;
                        const match = /filename\*=UTF-8''([^;]+)|filename="([^"]+)"|filename=([^;]+)/i.exec(header);
                        if (!match) return null;
                        return decodeURIComponent(match[1] || match[2] || match[3]).trim();
                    }

                    const cdHeader = response.headers.get('content-disposition');
                    let filename = getFileNameFromContentDisposition(cdHeader) || `${form.querySelector('input[name="bookingReference"]')?.value || '@Model.BookingReference'}_confirmation.pdf`;

                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    window.URL.revokeObjectURL(url);

                    const successModalEl = document.getElementById('paymentSuccessModal');
                    if (successModalEl) {
                        const modal = new bootstrap.Modal(successModalEl, { backdrop: 'static', keyboard: false });

                        try {
                            const controls = Array.from(form.querySelectorAll('input,select,textarea,button'));
                            controls.forEach(el => {
                                if (el.id === 'successRedirectBtn') return;
                                try { el.disabled = true; } catch (_) { /* ignore */ }
                            });

                            const anchors = Array.from(document.querySelectorAll('a'));
                            anchors.forEach(a => {
                                a.style.pointerEvents = 'none';
                                a.setAttribute('aria-hidden', 'true');
                                a.tabIndex = -1;
                            });

                            document.body.style.pointerEvents = 'none';
                            successModalEl.style.pointerEvents = 'auto';
                        } catch (e) {
                            console.debug('Could not fully disable page controls', e);
                        }

                        modal.show();
                    }
                } catch (err) {
                    console.error(err);
                    alert('Ett fel uppstod vid kommunikationen med servern.');
                } finally {
                    if (submitButton) submitButton.disabled = false;
                }
            });

            const bookingReference = '@Model.BookingReference';
            const connection = new signalR.HubConnectionBuilder()
                .withUrl("/bookinghub")
                .withAutomaticReconnect()
                .build();

            connection.on("BookingExpired", function (referenceNumber) {
                console.log("Booking expired:", referenceNumber);

                const modal = new bootstrap.Modal(document.getElementById('bookingExpiredModal'));
                modal.show();

                form.querySelectorAll('button[type="submit"]').forEach(btn => {
                    btn.disabled = true;
                });
            });

            document.getElementById('redirectBtn').addEventListener('click', function() {
                window.location.href = '@Url.Action("Browse", "Event")';
            });

            const successRedirectBtn = document.getElementById('successRedirectBtn');
            if (successRedirectBtn) {
                successRedirectBtn.addEventListener('click', function () {
                    try { connection.invoke("LeaveBookingGroup", bookingReference); } catch (_) { }
                    paymentSubmitted = true;
                    window.location.href = '@Url.Action("Browse", "Event")';
                });
            }

            connection.start()
                .then(function () {
                    console.log("SignalR Connected");
                    return connection.invoke("JoinBookingGroup", bookingReference);
                })
                .then(function () {
                    console.log("Joined booking group:", bookingReference);
                })
                .catch(function (err) {
                    console.error("SignalR Connection Error:", err);
                });

            window.addEventListener('beforeunload', function() {
                try { connection.invoke("LeaveBookingGroup", bookingReference); } catch (_) {}

                if (paymentSubmitted) return;

                const url = `/api/booking/cancle/${encodeURIComponent(bookingReference)}`;

                try {
                    fetch(url, {
                        method: 'DELETE',
                        keepalive: true,
                        credentials: 'same-origin'
                    }).catch(err => {
                        console.debug('Unload cancel fetch failed', err);
                    });
                } catch (e) {
                    console.debug('Unable to send unload cancel request', e);
                }
            });
        });
    </script>
}